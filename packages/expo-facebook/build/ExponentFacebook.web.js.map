{"version":3,"file":"ExponentFacebook.web.js","sourceRoot":"","sources":["../src/ExponentFacebook.web.ts"],"names":[],"mappings":"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","sourcesContent":["import { CodedError } from '@unimodules/core';\n\nimport { FacebookAuth } from './Facebook';\nimport {\n  FacebookLoginResult,\n  SDKScriptURLOptions,\n  FacebookOptions,\n  InitOptions,\n} from './Facebook.types';\n\ntype FB = any;\n\ndeclare var window: Window & { FB: FB; fbAsyncInit: Function };\n\nconst SCRIPT_ID = 'expo-facebook-generated-fbsdk-script';\n\nlet loadingFBSDKPromise: Promise<FB>;\n\nlet autoLogAppEvents: boolean = true;\nlet lastAppId: string;\n\nfunction throwIfUninitialized() {\n  if (!window.FB)\n    throw new CodedError(\n      'E_FB_CONF_ERROR',\n      'FBSDK is not initialized. Ensure `initializeAsync` has successfully resolved before attempting to use the FBSDK.'\n    );\n}\n\nfunction getScriptElement({\n  domain = 'connect.facebook.net',\n  language = 'en_US',\n  isCustomerSupportChatEnabled = false,\n  isDebugEnabled = false,\n}: SDKScriptURLOptions): HTMLScriptElement {\n  const scriptUrl = `https://${domain}/${language}/sdk${\n    isCustomerSupportChatEnabled ? '/xfbml.customerchat' : ''\n  }${isDebugEnabled ? '/debug' : ''}.js`;\n\n  const scriptElement = document.createElement('script');\n  scriptElement.async = true;\n  scriptElement.defer = true;\n  scriptElement.id = SCRIPT_ID;\n  scriptElement.src = scriptUrl;\n  return scriptElement;\n}\n\nfunction ensurePermissionsAreArray(permissions: string | string[]): string[] {\n  if (Array.isArray(permissions)) {\n    return permissions;\n  }\n  return permissions.split(',');\n}\n\nexport default {\n  get name(): string {\n    return 'ExponentFacebook';\n  },\n  async initializeAsync({\n    appId,\n    version = 'v5.0',\n    xfbml = true,\n    ...options\n  }: InitOptions): Promise<FB> {\n    if (!appId) {\n      throw new CodedError(\n        'E_FB_INIT',\n        `Failed to initialize app because the appId wasn't provided.`\n      );\n    }\n    if (loadingFBSDKPromise) {\n      return loadingFBSDKPromise;\n    }\n\n    loadingFBSDKPromise = new Promise(resolve => {\n      lastAppId = appId;\n      // The function assigned to window.fbAsyncInit is run as soon as the SDK has completed loading.\n      // Any code that you want to run after the SDK is loaded should be placed within this function and after the call to FB.init.\n      // Any kind of JavaScript can be used here, but any SDK functions must be called after FB.init.\n      window.fbAsyncInit = () => {\n        // https://developers.facebook.com/docs/javascript/reference/FB.init/v5.0\n        window.FB.init({\n          appId,\n          autoLogAppEvents:\n            options.autoLogAppEvents === undefined ? autoLogAppEvents : options.autoLogAppEvents,\n          xfbml,\n          version,\n        });\n\n        resolve(window.FB);\n      };\n\n      // If the script tag exists then resolve without creating a new one.\n      const element = document.getElementById(SCRIPT_ID);\n      if (element && element instanceof HTMLScriptElement) {\n        resolve(window.FB);\n      }\n\n      document.body.appendChild(\n        getScriptElement({\n          domain: options.domain,\n          language: options.language,\n          isDebugEnabled: options.isDebugEnabled,\n          isCustomerSupportChatEnabled: options.isCustomerSupportChatEnabled,\n        })\n      );\n    });\n\n    return loadingFBSDKPromise;\n  },\n  /**\n   * https://developers.facebook.com/docs/reference/javascript/FB.login/v5.0\n   *\n   * @param options\n   */\n  async logInWithReadPermissionsAsync(options: FacebookOptions): Promise<FacebookLoginResult> {\n    throwIfUninitialized();\n\n    const { permissions = ['public_profile', 'email'] } = options;\n\n    return new Promise(resolve => {\n      window.FB.login(\n        response => {\n          if (response.authResponse) {\n            resolve({\n              type: 'success',\n              token: response.authResponse.accessToken,\n              permissions: ensurePermissionsAreArray(response.authResponse.grantedScopes),\n              expires: response.authResponse.data_access_expiration_time,\n              // TODO: Add these if possible\n              declinedPermissions: [],\n            });\n          } else {\n            resolve({ type: 'cancel' });\n          }\n        },\n        {\n          scopes: permissions.join(','),\n          return_scopes: true,\n        }\n      );\n    });\n  },\n\n  async getAccessTokenAsync(): Promise<FacebookAuth | null> {\n    throwIfUninitialized();\n    return new Promise(resolve => {\n      window.FB.getLoginStatus(response => {\n        resolve(\n          response.authResponse\n            ? {\n                appID: lastAppId,\n                expires: response.authResponse.expires,\n                token: response.authResponse.accessToken,\n                userID: response.authResponse.userID,\n                signedRequest: response.authResponse.signedRequest,\n                graphDomain: response.authResponse.graphDomain,\n                dataAccessExpires: response.authResponse.data_access_expiration_time,\n              }\n            : null\n        );\n      });\n    });\n  },\n  async logOutAsync(): Promise<void> {\n    throwIfUninitialized();\n\n    // Prevent FB throwing a cryptic error message.\n    const auth = await this.getAccessTokenAsync();\n    if (!auth) return;\n\n    return new Promise(resolve => {\n      window.FB.logout(() => {\n        resolve();\n      });\n    });\n  },\n  setAutoLogAppEventsEnabledAsync(enabled: boolean) {\n    autoLogAppEvents = enabled;\n  },\n};\n"]}